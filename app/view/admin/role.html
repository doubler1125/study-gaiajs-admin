{% extends "./frame.html" %}
{% block content %}
{% raw %}
<style>
.rule {
  margin: 0px; width: 440px; height: 100px;
}
</style>

<div id="main_content">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h2>角色管理</h2>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <h3>列表</h3>
      </div>
      <div class="col-md-12">
        <el-table :data="roles">
          <el-table-column type="index" label="序号" > </el-table-column>
          <el-table-column label="角色" >
            <template slot-scope="props">
              {{ props.row.name }} <el-button type="danger" size='mini' icon="el-icon-delete" circle v-on:click.prevent="delRole(props.row)"></el-button>
            </template>
          </el-table-column>
          <el-table-column label="允许权限" >
            <template slot-scope="props">
                <el-input type="textarea" :autosize="{ minRows: 2, maxRows: 8}" v-model="props.row.allowValue"></el-input>
            </template>
          </el-table-column>
          <el-table-column label="禁止权限" >
            <template slot-scope="props">
                <el-input type="textarea" :autosize="{ minRows: 2, maxRows: 8}" v-model="props.row.denyValue"></el-input>
            </template>
          </el-table-column>
          <el-table-column label="允许规则" >
            <span class='bg-warning'>(正则表达式，每行一条)</span>
            <template slot-scope="props">
                <el-input type="textarea" :autosize="{ minRows: 2, maxRows: 8}" v-model="props.row.rules && props.row.rules.allowValue"></el-input>
            </template>
          </el-table-column>
          <el-table-column label="禁止规则" >
            <span class='bg-warning'>(正则表达式，每行一条)</span>
            <template slot-scope="props">
                <el-input type="textarea" :autosize="{ minRows: 2, maxRows: 8}" v-model="props.row.rules && props.row.rules.denyValue">{{ props.row.rules && props.row.rules.deny.join('\n') || '' }}</el-input>
            </template>
          </el-table-column>
          <el-table-column label="操作" >
            <template slot-scope="props">
                <el-button type="primary" size='mini' icon="el-icon-check" circle v-on:click.prevent="editRole(props.row)">提交</el-button>
            </template>
          </el-table-column>
        </el-table>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <h3>添加</h3>
      </div>
      <div class="col-md-12">
        <el-form :model="newRole" >
          <el-form-item label="ID" prop="id">
              <el-input v-model="newRole.id" auto-complete="off" ></el-input>
          </el-form-item>
          <el-form-item label="名称" prop="name">
              <el-input v-model="newRole.name" auto-complete="off" ></el-input>
          </el-form-item>
          <el-form-item label="允许权限" >
              <el-input type="textarea" :autosize="{ minRows: 2, maxRows: 8}" v-model="newRole.allowValue"></el-input>
          </el-form-item>
          <el-form-item label="禁止权限" >
                <el-input type="textarea" :autosize="{ minRows: 2, maxRows: 8}" v-model="newRole.denyValue"></el-input>
          </el-form-item>
          <el-form-item label="允许规则" >
            <span class='bg-warning'>(正则表达式，每行一条)</span>
                <el-input type="textarea" :autosize="{ minRows: 2, maxRows: 8}" v-model="newRole.rules && newRole.rules.allowValue"></el-input>
          </el-form-item>
          <el-form-item label="禁止规则" >
            <span class='bg-warning'>(正则表达式，每行一条)</span>
                <el-input type="textarea" :autosize="{ minRows: 2, maxRows: 8}" v-model="newRole.rules && newRole.rules.denyValue"></el-input>
          </el-form-item>
          <el-form-item label="操作">
            <el-button type="primary" size='mini' v-on:click.prevent="addRole(newRole)" >添加</el-button>
          </el-form-item>
        </el-form>
      </div>
    </div>
  </div>

</div>


<script type="application/javascript">
  new Vue({
    el: '#main_content',
    data: {
      roles: [],

      newRole: { id: '', name: '', allowValue: '', denyValue: '', rules: { allowValue: '', denyValue: '' } },
    },
    created: function () {
      this.loadData();
    },
    methods: {
      async loadData() {
        try {
          const response = await axios.get('roles');
          const result = response.data;
          if (result && result.data) {
            this.roles = result.data.roles.map((role)=>{
              role.allowValue = role.allow.join('\n')+(role.allow && role.allow.length>0?'\n':'');
              role.denyValue = role.deny.join('\n')+(role.deny && role.deny.length>0?'\n':'');

              if (role.rules) {
                if (role.rules.allow) {
                  role.rules.allowValue = role.rules.allow.join('\n')+(role.rules.allow && role.rules.allow.length>0?'\n':'');
                }
                if (role.rules.deny) {
                  role.rules.denyValue = role.rules.deny.join('\n')+(role.rules.deny && role.rules.deny.length>0?'\n':'');
                }
              }

              return role;
            });
          } else {
            alert('请求角色列表失败: '+(result && (result.info || result.msg)));
          }
        } catch (error) {
          alert('请求角色列表失败: ' + error.message);
        }
      },

      async editRole(role) {
        try {
          const data = { name: role.name, allow: role.allowValue && role.allowValue.split('\n') || [], deny: role.denyValue && role.denyValue.split('\n') || [], rules: { allow: role.rules && role.rules.allowValue.split('\n') || [], deny: role.rules && role.rules.denyValue.split('\n') || [] } }
          const response = await axios.put('role', { name: role.id, role: data });
          const result = response.data;
          if (result && result.data) {
            await this.loadData();
          } else {
            alert('修改角色失败: '+(result && (result.info || result.msg)));
          }
        } catch (error) {
          alert('修改角色失败' + error.message);
        }
      },

      async delRole(role) {
        try {
          if (role.id === 'super'|| role.id === 'anonymous') {
            alert('禁止删除');
            return;
          }

          const response = await axios.delete('role', { data: { role: role.id } });
          const result = response.data;
          if (result && result.success) {
            await this.loadData();
          } else {
            alert('删除角色失败: '+(result && (result.info || result.msg)));
          }
        } catch (error) {
          alert('删除角色失败' + error.message);
        }
      },

      async addRole(role) {
        try {
          const data = {id: role.id, name: role.name, allow: role.allowValue.split('\n'), deny: role.denyValue.split('\n'), rules: { allow: role.rules && role.rules.allowValue.split('\n') || [], deny: role.rules && role.rules.denyValue.split('\n') || [] }}
          const response = await axios.post('role', { role: data });
          const result = response.data;
          if (result && result.data) {
            await this.loadData();
          } else {
            alert('添加角色失败: '+(result && (result.info || result.msg)));
          }
        } catch (error) {
          alert('添加角色失败' + error.message);
        }
      }
    }
  })

</script>

{% endraw %}
{% endblock %}
